<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
    <title>显示地图</title>
    <style type="text/css">
        html, body{ height:100%; margin:0; padding:0;}
        #mapDiv{ width:500px; height:400px; background-color:#EFF5FF;}
    </style>
<!--     <script src="http://api.shipxy.com/apdll/ap.dll?api=map&amp;key=1F6D701272402D1E7D8D316CCE519123&amp;ver=1.3" type="text/javascript"></script> -->
    <script src="API.js" type="text/javascript"></script>
    <script src="jquery-2.1.1.js"></script>
    <script type="text/javascript">
        var map;
        window.onload = function () {
            var mapOptions = new shipxyMap.MapOptions();
            mapOptions.center = new shipxyMap.LatLng(32, 122);
            mapOptions.zoom = 5;
            mapOptions.mapType = shipxyMap.MapType.GOOGLEMAP;
            //mapDiv是一个DIV容器的id，用于放置flash地图组件
            map = new shipxyMap.Map('mapDiv', mapOptions); //创建地图实例
            //地图初始化完毕
            shipxyMap.mapReady = function () {
                //地图初始化完毕才能操作 地图其他的接口
                
                $.ajax({
					type:'get',
					async: true,
					url:'http://118.89.166.247:8004/getShipByRect/',
					//url:'http://127.0.0.1:8000/boats/',
					dataType:'jsonp',
					jsonp:'callback',
					jsonpCallback:'successCallback',
					success:function(data){
						totalShip = data['total'];
						boatArray = data['result'];
						//setPoint(boatArray,0);
						addShips(totalShip,boatArray);
					},
					error:function(XMLHttpRequest, textStatus, errorThrown){
						alert(XMLHttpRequest.status);
						alert(XMLHttpRequest.readyState);
						alert(textStatus);
					}
				});
            }
        }
        function addShips(totalShip,boatArray){
        	//船舶显示样式
        	
            var option = new shipxyMap.ShipOptions();
            /*边框样式*/
            option.strokeStyle.color = 0xff0000;
            option.strokeStyle.alpha = 1;
            option.strokeStyle.thickness = 2;
            /*填充样式*/
            option.fillStyle.color = 0x00ff00;
            option.fillStyle.alpha = 1;
            /*标签样式*/
            //标签线条
            option.labelOptions.border = true; //有边框  
            option.labelOptions.borderStyle.color = 0x000000;
            option.labelOptions.borderStyle.alpha = 1;
            //标签文字
            option.labelOptions.fontStyle.name = "Verdana";
            option.labelOptions.fontStyle.size = "12";
            option.labelOptions.fontStyle.color = 0x000000;
            option.labelOptions.fontStyle.bold = true;  //粗体
            option.labelOptions.fontStyle.bold = true;  //斜体
            option.labelOptions.fontStyle.underline = true;  //下划线
            //标签填充
            option.labelOptions.background = true; //有背景  
            option.labelOptions.backgroundStyle.color = 0xffff66;  //边框样式
            option.labelOptions.backgroundStyle.alpha = 1;
            option.isShowLabel = true; //是否显示label
            option.isShowMiniTrack = true//船舶自带三分钟轨迹
            option.isSelected = false; //船舶框选
            option.zoomLevels = [1, 18]; //显示级别
            var data = new shipxyAPI.Ship();
            
            for(var i=0;i<totalShip;i++){
	            data.MMSI = boatArray[i].mmsi;
	            data.name = boatArray[i].shipname;
	            data.length = boatArray[i].length;
	            data.beam = boatArray[i].breadth;
	            data.lat = tudeTran(boatArray[i].latitude);
	            data.lng = tudeTran(boatArray[i].longitude);
	            data.heading = boatArray[i].heading;
	            data.course = boatArray[i].course;
	            data.speed = boatArray[i].speed;
	            data.lastTime = boatArray[i].postime;
	            addshipOverlay = new shipxyMap.Ship(data.MMSI, data, option);
	            map.addOverlay(addshipOverlay, true);
	            console.log(i+" "+data.MMSI);
            }            
            
        }
        function tudeTran(tude){
			minutes = tude/10000
			degree = parseInt(minutes/60)
			min = parseInt(minutes%60)
			sec = minutes%1
			sec = sec.toFixed(4)*60
			decDegree = degree+min/60+sec/3600
			return decDegree
		}
        //加船
        function addShip() {
            //船舶显示样式
            var option = new shipxyMap.ShipOptions();
            /*边框样式*/
            option.strokeStyle.color = 0xff0000;
            option.strokeStyle.alpha = 1;
            option.strokeStyle.thickness = 2;
            /*填充样式*/
            option.fillStyle.color = 0x00ff00;
            option.fillStyle.alpha = 1;
            /*标签样式*/
            //标签线条
            option.labelOptions.border = true; //有边框  
            option.labelOptions.borderStyle.color = 0x000000;
            option.labelOptions.borderStyle.alpha = 1;
            //标签文字
            option.labelOptions.fontStyle.name = "Verdana";
            option.labelOptions.fontStyle.size = "12";
            option.labelOptions.fontStyle.color = 0x000000;
            option.labelOptions.fontStyle.bold = true;  //粗体
            option.labelOptions.fontStyle.bold = true;  //斜体
            option.labelOptions.fontStyle.underline = true;  //下划线
            //标签填充
            option.labelOptions.background = true; //有背景  
            option.labelOptions.backgroundStyle.color = 0xffff66;  //边框样式
            option.labelOptions.backgroundStyle.alpha = 1;
            option.isShowLabel = true; //是否显示label
            option.isShowMiniTrack = true//船舶自带三分钟轨迹
            option.isSelected = false; //船舶框选
            option.zoomLevels = [1, 18]; //显示级别
            var data = new shipxyAPI.Ship();            
            data.shipId = "";
            data.MMSI = '412371410';
            //data.IMO = '';
            data.name = 'shipName2';
//             data.callsign = 'BIPE';
//             data.type = '货船';
//             data.cargoType = ''; //货物类型
//             data.country = ''; //国籍
//             data.status = '在航（主机推动）';
            data.length = 135;
            data.beam = 21;
//             data.draught = 7.3;
            data.lat = -10;
            data.lng = -10;
            data.heading = 60;
            data.course = 80;
            data.speed = 13;
//             data.rot = -1;
//             data.dest = 'BEH LUN';
//             data.eta = '6.26 21:00';
            data.lastTime = 1340674688;
            addshipOverlay = new shipxyMap.Ship(data.shipId, data, option);
            map.addOverlay(addshipOverlay, true);
        }
        function removeShip() {
            if (addshipOverlay) {
                map.removeOverlay(addshipOverlay);
                addshipOverlay = null;
            }
        }
        function locateShip() {
            if (addshipOverlay) map.locateOverlay(addshipOverlay, 10);
        }
        //获取船信息
        function getShipData() {
            var shipId = document.getElementById('shipId').value;
            if (shipId) {
                var result = document.getElementById('result');
                var ships = new shipxyAPI.Ships(shipId, shipxyAPI.Ships.INIT_SHIPID);
                ships.getShips(function (status) {
                    var data = this.data;
                    if (status == 0) {
                        var c = '';
                        if (data && data.length > 0) {
                            var d = data[0];
                            c += createTableByShipData(d);
                            locateShipById(d.shipId);
                        } else {
                            c += '没有该船舶数据';
                        }
                        result.innerHTML = c;
                    } else {
                        alert('获取该船舶数据出错！');
                    }
                });
            }
        }
        function createTableByShipData(d) {
            return '<table><tr>'
            + '<td>船名：</td><td title="' + d.name + '">' + d.name + '</td>'
            + '<td>纬度：</td><td title="' + d.lat + '">' + d.lat + '</td>'
            + '</tr><tr>'
            + '<td>呼号：</td><td title="' + d.callsign + '">' + d.callsign + '</td>'
            + '<td>经度：</td><td title="' + d.lng + '">' + d.lng + '</td>'
            + '</tr><tr>'
            + '<td>MMSI：</td><td title="' + d.MMSI + '">' + d.MMSI + '</td>'
            + '<td>船首向：</td><td title="' + d.heading + '">' + d.heading + '</td>'
            + '</tr><tr>'
            + '<td>IMO：</td><td title="' + d.IMO + '">' + d.IMO + '</td>'
            + '<td>航迹向：</td><td title="' + d.course + '">' + d.course + '</td>'
            + '</tr><tr>'
            + '<td>船籍：</td><td title="' + d.country + '">' + d.country + '</td>'
            + '<td>航速：</td><td title="' + d.speed + '">' + d.speed + '</td>'
            + '</tr><tr>'
            + '<td>类型：</td><td title="' + d.type + '">' + d.type + '</td>'
            + '<td>货物类型：</td><td title="' + d.cargoType + '">' + d.cargoType + '</td>'
            + '</tr><tr>'
            + '<td>状态：</td><td title="' + d.status + '">' + d.status + '</td>'
            + '<td>目的地：</td><td title="' + d.dest + '">' + d.dest + '</td>'
            + '</tr><tr>'
            + '<td>船长：</td><td title="' + d.length + '">' + d.length + '</td>'
            + '<td>预到时间：</td><td title="' + d.eta + '">' + d.eta + '</td>'
            + '</tr><tr>'
            + '<td>船宽：</td><td title="' + d.beam + '">' + d.beam + '</td>'
            + '<td>最后时间：</td><td title="' + d.lastTime + '">' + d.lastTime + '</td>'
            + '</tr><tr>'
            + '<td>吃水：</td><td title="' + d.draught + '">' + d.draught + '</td>'
            + '<td>旋转角速度：</td><td title="' + d.rot + '">' + d.rot + '</td>'
            + '</tr></table>';
        }
        function locateShipById(shipId) {
            map.removeAllOverlay();
            var ships = new shipxyAPI.Ships(shipId, shipxyAPI.Ships.INIT_SHIPID);
            ships.getShips(function (status) {
                var data = this.data;
                if (status == 0 && data && data.length > 0) {
                    var d = data[0];
                    var ship = new shipxyMap.Ship(d.shipId, d);
                    map.addOverlay(ship);
                    map.locateOverlay(ship);
                } else {
                    alert('定位该船出错！');
                }
            });
        }
    </script>
</head>
<body>
    <div id="mapDiv"></div>
    <input type="button" value="添加船舶" onclick="addShip()" />
    <input type="button" value="删除船舶" onclick="removeShip()" />
    <input type="button" value="定位船舶" onclick="locateShip()" />
    
    <p><label for="shipId">船舶ID：</label><input type="text" id="shipId" value="412371410"/><input type="button" value="获取" onclick="getShipData()" /></p>
    <div id="result"></div>
</body>
</html>
