<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
    <title>显示地图</title>
    <style type="text/css">
        html, body{ height:100%; margin:0; padding:0;}
        #mapDiv{ width:90%; height:90%; background-color:#EFF5FF;}
    </style>
    <link rel="stylesheet" type="text/css" href="xwin.css"/>
    
    
<!--     <script src="http://api.shipxy.com/apdll/ap.dll?api=map&amp;key=1F6D701272402D1E7D8D316CCE519123&amp;ver=1.3" type="text/javascript"></script> -->
    <script src="API.js" type="text/javascript"></script>
    <script src="jquery-2.1.1.js"></script>
    <script src="boats.js"></script>
    <script src="xwin.js"></script>
    <script type="text/javascript" src="common.js"></script>
    <script type="text/javascript">
        var map;
        window.onload = function () {
            var mapOptions = new shipxyMap.MapOptions();
            mapOptions.center = new shipxyMap.LatLng(32, 122);
            mapOptions.zoom = 5;
            mapOptions.mapType = shipxyMap.MapType.GOOGLEMAP;
            mapOptions.language="en";
            //mapDiv是一个DIV容器的id，用于放置flash地图组件
            map = new shipxyMap.Map('mapDiv', mapOptions); //创建地图实例
            //地图初始化完毕
            shipxyMap.mapReady = function () {
                //地图初始化完毕才能操作 地图其他的接口
                addshipOverlayArray = new Array();
                shipOverlayIdArray = new Array();
				var url='http://118.89.166.247:8004/getShipByRect/';//2000数据
// 				var url='http://115.159.120.151:3389/getShipByRect/';//1W条数据
// 				var url='http://127.0.0.1:8000/boats/';
                getdata(url,addShips,true);
            }
        }
        //获取数据
        function getdata(u,callback,xss){
        	if(xss){
	        	$.ajax({
					type:'get',
					async: true,
					url:u,
					dataType:'jsonp',
					jsonp:'callback',
					jsonpCallback:'successCallback',
					success:function(data){
						callback.call(this,data);
					},
					error:function(XMLHttpRequest, textStatus, errorThrown){
						alert(XMLHttpRequest.status);
						alert(XMLHttpRequest.readyState);
						alert(textStatus);
					}
				});
        	}
        	else{
        		$.get(u,function(data){
        			callback.call(this,data);
        		});
        	}
        	
        }
        //打开窗口
        var testWin = null;
        function openWin(shipId) {
            /*if (!testWin) {
                if (shipId) {
    				var url='http://git.ctticsh.cn:8088/getShipBasicInformation?key=5cdd7336161c4ce2a27a21d770b8aa53&shipid='+shipId;
    				url='http://115.159.120.151:3389/addCallback/?url='+encodeURIComponent(url);
    				//console.log(encodeURI(url));
                    getdata(url,function(data){
                    	var boatArray = data['result'];
                    	var totalShip = data['total'];
                    	var c = '';
                    	if(boatArray.length==0){
                    		c += '没有该船舶数据';
                    	}
                    	for(var i=0;i<boatArray.length;i++){
                            c += createTableByShipData(boatArray[i],shipId);
                    	}
                    	//result.innerHTML = c;
                    	testWin = new XWin({
                            modal: false, //指定模态
                            width: 420,//弹出框的宽度
                            position: [360, 200], //[left,top]，设置弹出框的弹出位置，若不指定则默认为屏幕中心点
                            title: '窗口标题',//窗口的标题，可以是html内容，如：<a href="http://www.***.com">********</a>
                            content: c,//窗口的内容，也可以是html内容
                            onhide: function () {//关闭窗口后的回调函数，可以在这里处理窗口关闭后的操作
                            	testWin = null;//无
                            }
                        });
                    	
                    },true);               
                }
            }*/
            
            
            if (!testWin) {
            	testWin = new XWin({
                    modal: false, //指定模态
                    width: 420,//弹出框的宽度
                    position: [360, 200], //[left,top]，设置弹出框的弹出位置，若不指定则默认为屏幕中心点
                    title: '窗口标题',//窗口的标题，可以是html内容，如：<a href="http://www.***.com">********</a>
                    content: '<div id=\'shipInfo\'></div>',//窗口的内容，也可以是html内容
                    onhide: function () {//关闭窗口后的回调函数，可以在这里处理窗口关闭后的操作
                    	//testWin = null;//无
                    }
                });
                
            }
            if (shipId) {
            	var result = document.getElementById('shipInfo');
            	result.innerHTML = '';
				var url='http://git.ctticsh.cn:8088/getShipBasicInformation?key=5cdd7336161c4ce2a27a21d770b8aa53&shipid='+shipId;
				url='http://115.159.120.151:3389/addCallback/?url='+encodeURIComponent(url);
				//console.log(encodeURI(url));
                getdata(url,function(data){
                	var boatArray = data['result'];
                	var totalShip = data['total'];
                	var c = '';
                	if(boatArray.length==0){
                		c += '没有该船舶数据';
                	}
                	for(var i=0;i<boatArray.length;i++){
                        c += createTableByShipData(boatArray[i],shipId);
                	}
                	result.innerHTML = c;
                },true);               
            }
            //testWin.setTitle('窗口新标题');//可以通过此方法重设窗口标题
            //testWin.setContent('窗口新内容');//可以通过此方法重设窗口内容
            testWin.show(); //显示
        }
        
        //批量载入
        function addShips(data){
        	//船舶显示样式
			totalShip = data['total'];
			boatArray = data['result'];
            var option = new shipxyMap.ShipOptions();
            /*边框样式*/
//             option.strokeStyle.color = 0xff0000;
//             option.strokeStyle.alpha = 1;
//             option.strokeStyle.thickness = 2;
            /*填充样式*/
//             option.fillStyle.color = 0x00ff00;
//             option.fillStyle.alpha = 1;
            /*标签样式*/
            //标签线条
//             option.labelOptions.border = true; //有边框  
//             option.labelOptions.borderStyle.color = 0x000000;
//             option.labelOptions.borderStyle.alpha = 1;
            //标签文字
//             option.labelOptions.fontStyle.name = "Verdana";
//             option.labelOptions.fontStyle.size = "12";
//             option.labelOptions.fontStyle.color = 0x000000;
//             option.labelOptions.fontStyle.bold = true;  //粗体
//             option.labelOptions.fontStyle.bold = true;  //斜体
//             option.labelOptions.fontStyle.underline = true;  //下划线
            //标签填充
//             option.labelOptions.background = true; //有背景  
//             option.labelOptions.backgroundStyle.color = 0xffff66;  //边框样式
//             option.labelOptions.backgroundStyle.alpha = 1;
            option.isShowLabel = true; //是否显示label
            //option.isShowMiniTrack = true//船舶自带三分钟轨迹
            option.isSelected = false; //船舶框选
            option.zoomlevels = [5, 18]; //显示级别
            option.labelOptions.zoomlevels = [15,18];
            
            
            for(var i=0;i<totalShip;i++){
            	var data = new shipxyAPI.Ship();
	            data.MMSI = boatArray[i].mmsi;
	            data.name = boatArray[i].shipname;
	            data.length = boatArray[i].length;
	            data.beam = boatArray[i].breadth;
	            data.lat = tudeTran(boatArray[i].latitude);
	            data.lng = tudeTran(boatArray[i].longitude);
	            data.heading = boatArray[i].heading/10;
	            data.course = boatArray[i].course/10;
	            data.speed = boatArray[i].speed;
	            data.lastTime = boatArray[i].postime;
	            var shipOverlay = new shipxyMap.Ship(data.MMSI, data, option);
	            //map.addOverlay(addshipOverlay, true);
	            map.addOverlay(shipOverlay);
	            //addshipOverlayArray.push(shipOverlay);
	            shipOverlayIdArray[shipOverlay.id]=shipOverlay;
	            console.log(shipOverlay.data.name);
	            addshipOverlayArray[data.MMSI]=shipOverlay;
            }
            
            for(var i in shipOverlayIdArray){
            	console.log(i,shipOverlayIdArray[i].data.name);
            }
            
            map.addShipEventListener(shipxyMap.Event.CLICK, function (event) {
            	var shipId = event.overlayId;
            	//alert(shipOverlayIdArray[shipId].data.name);
            	openWin(shipId);
            	console.log(shipId);
            });
            
            
        }
        
        //经纬度换算
        function tudeTran(tude){
			minutes = tude/10000
			degree = parseInt(minutes/60)
			min = parseInt(minutes%60)
			sec = minutes%1
			sec = sec.toFixed(4)*60
			decDegree = degree+min/60+sec/3600
			return decDegree
		}
        //加船
        function addShip() {
            //船舶显示样式
            var option = new shipxyMap.ShipOptions();
            /*边框样式*/
            option.strokeStyle.color = 0xff0000;
            option.strokeStyle.alpha = 1;
            option.strokeStyle.thickness = 2;
            /*填充样式*/
            option.fillStyle.color = 0x00ff00;
            option.fillStyle.alpha = 1;
            /*标签样式*/
            //标签线条
            option.labelOptions.border = true; //有边框  
            option.labelOptions.borderStyle.color = 0x000000;
            option.labelOptions.borderStyle.alpha = 1;
            //标签文字
            option.labelOptions.fontStyle.name = "Verdana";
            option.labelOptions.fontStyle.size = "12";
            option.labelOptions.fontStyle.color = 0x000000;
            option.labelOptions.fontStyle.bold = true;  //粗体
            option.labelOptions.fontStyle.bold = true;  //斜体
            option.labelOptions.fontStyle.underline = true;  //下划线
            //标签填充
            option.labelOptions.background = true; //有背景  
            option.labelOptions.backgroundStyle.color = 0xffff66;  //边框样式
            option.labelOptions.backgroundStyle.alpha = 1;
            option.isShowLabel = true; //是否显示label
            option.isShowMiniTrack = true//船舶自带三分钟轨迹
            option.isSelected = false; //船舶框选
            option.zoomLevels = [1, 18]; //显示级别
            var data = new shipxyAPI.Ship();            
            data.shipId = "";
            data.MMSI = '412371410';
            //data.IMO = '';
            data.name = 'shipName2';
//             data.callsign = 'BIPE';
//             data.type = '货船';
//             data.cargoType = ''; //货物类型
//             data.country = ''; //国籍
//             data.status = '在航（主机推动）';
            data.length = 135;
            data.beam = 21;
//             data.draught = 7.3;
            data.lat = -10;
            data.lng = -10;
            data.heading = 60;
            data.course = 80;
            data.speed = 13;
//             data.rot = -1;
//             data.dest = 'BEH LUN';
//             data.eta = '6.26 21:00';
            data.lastTime = 1340674688;
            addshipOverlay = new shipxyMap.Ship(data.shipId, data, option);
            map.addOverlay(addshipOverlay, true);
        }
        function removeShip() {
            if (addshipOverlay) {
                map.removeOverlay(addshipOverlay);
                addshipOverlay = null;
            }
        }
        function locateShip(shipId) {
            if (addshipOverlayArray[shipId]) map.locateOverlay(addshipOverlayArray[shipId], 10);
        }
        //获取船信息
        function getShipData() {
            var shipId = document.getElementById('shipId').value;
            if (shipId) {
//                 var result = document.getElementById('result');
//                 var ships = new shipxyAPI.Ships(shipId, shipxyAPI.Ships.INIT_SHIPID);
//                 ships.getShips(function (status) {
//                     var data = this.data;
//                     if (status == 0) {
//                         var c = '';
//                         if (data && data.length > 0) {
//                             var d = data[0];
//                             c += createTableByShipData(d);
//                             locateShipById(d.shipId);
//                         } else {
//                             c += '没有该船舶数据';
//                         }
//                         result.innerHTML = c;
//                     } else {
//                         alert('获取该船舶数据出错！');
//                     }
//                 });
				var result = document.getElementById('result');
				var url='http://git.ctticsh.cn:8088/getShipBasicInformation?key=5cdd7336161c4ce2a27a21d770b8aa53&shipid='+shipId;
				url='http://115.159.120.151:3389/addCallback/?url='+encodeURIComponent(url);
				//console.log(encodeURI(url));
                getdata(url,function(data){
                	var boatArray = data['result'];
                	var totalShip = data['total'];
                	var c = '';
                	if(boatArray.length==0){
                		c += '没有该船舶数据';
                	}
                	for(var i=0;i<boatArray.length;i++){
                        c += createTableByShipData(boatArray[i],shipId);
                        locateShip(shipId);
                	}
                	result.innerHTML = c;
                },true);               
            }
        }
        function createTableByShipData(d,shipId) {
            return '<table><tr>'
            + '<td>船名：</td><td title="' + d.shipname + '">' + d.shipname + '</td>'
            + '<td>纬度：</td><td title="' + addshipOverlayArray[shipId].data.lat + '">' + addshipOverlayArray[shipId].data.lat + '</td>'
            + '</tr><tr>'
            + '<td>呼号：</td><td title="' + d.callsign + '">' + d.callsign + '</td>'
            + '<td>经度：</td><td title="' + addshipOverlayArray[shipId].data.lng + '">' + addshipOverlayArray[shipId].data.lng + '</td>'
            + '</tr><tr>'
            + '<td>MMSI：</td><td title="' + d.mmsi + '">' + d.mmsi + '</td>'
            + '<td>船首向：</td><td title="' + addshipOverlayArray[shipId].data.heading + '">' + addshipOverlayArray[shipId].data.heading + '</td>'
            + '</tr><tr>'
            + '<td>IMO：</td><td title="' + d.imo + '">' + d.imo + '</td>'
            + '<td>航迹向：</td><td title="' + addshipOverlayArray[shipId].data.course + '">' + addshipOverlayArray[shipId].data.course + '</td>'
            + '</tr><tr>'
            //+ '<td>船籍：</td><td title="' + d.country + '">' + d.country + '</td>'
            + '<td>航速：</td><td title="' + addshipOverlayArray[shipId].data.speed + '">' + addshipOverlayArray[shipId].data.speed + '</td>'
            + '</tr><tr>'
            //+ '<td>类型：</td><td title="' + d.type + '">' + d.type + '</td>'
            //+ '<td>货物类型：</td><td title="' + d.cargoType + '">' + d.cargoType + '</td>'
            + '</tr><tr>'
            //+ '<td>状态：</td><td title="' + d.status + '">' + d.status + '</td>'
            + '<td>目的地：</td><td title="' + d.dest_port + '">' + d.dest_port + '</td>'
            + '</tr><tr>'
            + '<td>船长：</td><td title="' + d.length + '">' + d.length + '</td>'
            + '<td>预到时间：</td><td title="' + d.eta + '">' + d.eta + '</td>'
            + '</tr><tr>'
            + '<td>船宽：</td><td title="' + d.breadth + '">' + d.breadth + '</td>'
            + '<td>最后时间：</td><td title="' + addshipOverlayArray[shipId].data.lastTime + '">' + addshipOverlayArray[shipId].data.lastTime + '</td>'
            + '</tr><tr>'
            + '<td>吃水：</td><td title="' + d.draught + '">' + d.draught + '</td>'
            //+ '<td>旋转角速度：</td><td title="' + d.rot + '">' + d.rot + '</td>'
            + '</tr></table>';
        }
		
		function addMarker() {
            //removeMarker();
            /*****面显示样式*****/
            var opts = new shipxyMap.MarkerOptions()
            opts.zoomlevels = [1, 18]; //显示级别
            //opts.zIndex = 4;  //显示层级
            opts.isShowLabel = true; //是否显示label
            //opts.isEditable = true; //是否可编辑
            opts.imageUrl = '../js/img/mark.png'; //图片URL
            //opts.imagePos = new shipxyMap.Point(0, 0); //图片偏移量
            /*标签样式*/
            //标签线条
            opts.labelOptions.border = true; //有边框  
            opts.labelOptions.borderStyle.color = 0xff0000;
            opts.labelOptions.borderStyle.alpha = 0.8;
            opts.labelOptions.borderStyle.thickness = 1;
            //标签文字
            opts.labelOptions.fontStyle.name = 'Verdana';
            opts.labelOptions.fontStyle.size = 14;
            opts.labelOptions.fontStyle.color = 0xff33cc;
            opts.labelOptions.fontStyle.bold = true;  //粗体
            opts.labelOptions.fontStyle.italic = true;  //斜体
            opts.labelOptions.fontStyle.underline = true;  //下划线
            //标签填充
            opts.labelOptions.background = true; //有背景  
            opts.labelOptions.backgroundStyle.color = 0xffccff;  //边框样式
            opts.labelOptions.backgroundStyle.alpha = 0.6;
            opts.labelOptions.zoomlevels = [5, 12]; //显示级别
            opts.labelOptions.text = '自定义点';
            opts.labelOptions.labelPosition = new shipxyMap.Point(0, 0);
            /*****点*****/
            var data = [];
            //DATASTART
            data[0] = new shipxyMap.LatLng(37.2, 122);
            //DATAEND
            data = new shipxyMap.LatLng(data[0].lat, data[0].lng);
            marker = new shipxyMap.Marker('MyMarker1', data, opts);
            //添加到地图上显示
            map.addOverlay(marker, true); //优先显示
            map.locateOverlay(marker, 15);
        }
        function removeMarker() {
            if (marker) {
                map.removeOverlay(marker);
                marker = null;
            }
        }
        function locateMarker() {
            if (marker) map.locateOverlay(marker, 10);
        }
    </script>
</head>
<body>
    <div id="mapDiv"></div>
<!--     <input type="button" value="添加船舶" onclick="addShip()" /> -->
<!--     <input type="button" value="删除船舶" onclick="removeShip()" /> -->
	<input type="button" value="添加点" onclick="addMarker()" />
    <input type="button" value="定位船舶" onclick="locateShip()" />
    
    <p><label for="shipId">船舶ID：</label><input type="text" id="shipId" value="275475000"/><input type="button" value="获取" onclick="getShipData()" /></p>
    <div id="result"></div>
</body>
</html>
